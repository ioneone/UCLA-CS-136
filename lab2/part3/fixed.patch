--- FCCU.php	2021-01-18 23:45:52.000000000 -0800
+++ FCCU2.php	2021-01-19 00:20:31.000000000 -0800
@@ -31,59 +31,63 @@
 	$id = $PARAM['id'];
 	$password = $PARAM['password'];
 
-        $mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
-   
-   	$query = "SELECT * FROM accounts WHERE id = $id AND password = '$password'";
-	debug($query);
-	$result = $mysqli->query($query) or die($mysqli->error);
-	$row = $result->fetch_array(); // there should be only one row
-	
-	if (!$row) { // auth failure
-		echo "<p><b>Your ID number and password you entered do not match.</b></p>";
+	if (!is_numeric($id)) {
+		echo "<p><b>Account ID must be numeric</b></p>";
 		echo "<p>Please try again.</p>";
 		login();
-	} else { // this user is authenticated!
-		
-		// store authentication information in this form
-		echo "<input type=\"hidden\" name=\"id\" value=\"$id\" />\n";
-		echo "<input type=\"hidden\" name=\"password\" value=\"$password\" />\n";
+	} else if (!ctype_alnum($password)) {
+		echo "<p><b>Password must be alphanumeric</b></p>";
+		echo "<p>Please try again.</p>";
+		login();
+	} else {
+		$mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
+   
+		$query = $mysqli->prepare("SELECT * FROM accounts WHERE id = ? AND password = ?");
+		$query->bind_param('is', $id, $password);
+		debug($query);
+		$query->execute();
+		$result = $query->get_result() or die($mysqli->error);
+		$row = $result->fetch_array(); // there should be only one row
 		
-		banner($row[2], $row[3]);
+		if (!$row) { // auth failure
+			echo "<p><b>Your ID number and password you entered do not match.</b></p>";
+			echo "<p>Please try again.</p>";
+			login();
+		} else { // this user is authenticated!
+			
+			// store authentication information in this form
+			echo "<input type=\"hidden\" name=\"id\" value=\"$id\" />\n";
+			echo "<input type=\"hidden\" name=\"password\" value=\"$password\" />\n";
+			
+			banner($row[2], $row[3]);
+			
+			// perform any requested actions (wire, transfer, withdraw)
+			if ($PARAM['action'] == 'Transfer Money') {
+				transfer_funds($id, $password, $PARAM['transfer_to'], $PARAM['transfer_amount']);
+			} elseif ($PARAM['action'] == 'Wire Money') {
+				wire_funds($id, $password, $PARAM['routing'], $PARAM['wire_acct'], $PARAM['wire_amount']);
+			} elseif ($PARAM['action'] == 'Withdraw Money') {
+				withdraw_cash($id, $password, $PARAM['withdraw_amount']);
+			}
+
+			// normal output
+			
+			// account info
+			$query = $mysqli->prepare("SELECT * FROM accounts WHERE id = ? AND password = ?");
+			$query->bind_param('is', $id, $password);
+			$query->execute();
+			$result = $query->get_result() or die($mysqli->error());
+			$row = $result->fetch_array(); // there should be only one row
+			account_info($row);
 		
-		// perform any requested actions (wire, transfer, withdraw)
-		if ($PARAM['action'] == 'Transfer Money') {
-			transfer_funds($id, 
-				       $password,
-			               $PARAM['transfer_to'], 
-				       $PARAM['transfer_amount']);
-		} elseif ($PARAM['action'] == 'Wire Money') {
-			wire_funds($id,
-			            $password,
-		                    $PARAM['routing'],
-			            $PARAM['wire_acct'],
-			            $PARAM['wire_amount']);
-		} elseif ($PARAM['action'] == 'Withdraw Money') {
-			withdraw_cash($id,
-			              $password,
-		                      $PARAM['withdraw_amount']);
+			// get current account list by name
+			$query = "SELECT first, last FROM accounts ORDER BY last";
+			$names = $mysqli->query($query) or die($mysqli->error());
+			$row = $names->fetch_array();
+			account_actions($row, $names);
 		}
-
-		// normal output
-		
-		// account info
-                $query = "SELECT * FROM accounts WHERE id = $id AND password = '$password'";
-		$result = $mysqli->query($query) or die($mysqli->error());
-                $row = $result->fetch_array(); // there should be only one row
-		account_info($row);
-	
-		// get current account list by name
-		$query = "SELECT first, last FROM accounts ORDER BY last";
-                $names = $mysqli->query($query) or die($mysqli->error());
-                $row = $names->fetch_array();
-		account_actions($row, $names);
 	}
 
-
 }
 echo "<hr>\n";
 echo "Generated by FCCU.php at " . date("l M dS, Y, H:i:s",5678)."<br>";
@@ -93,12 +97,14 @@
 	global $dbhost, $dbuser, $dbpass, $dbname;
 	$splitname = explode(", ", $name);
 
-        $mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
+    $mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
    
-	$query = "SELECT id FROM accounts WHERE first = '$splitname[1]' AND last = '$splitname[0]'";
+	$query = $mysqli->prepare("SELECT id FROM accounts WHERE first = ? AND last = ?");
+	$query->bind_param('ss', $splitname[1], $splitname[0]);
 	debug($query);
-	$result = $mysqli->query($query) or die($mysqli->error);
-        $row = $result->fetch_array(); // there should be only one row
+	$query->execute();
+	$result = $query->get_result() or die($mysqli->error);
+    $row = $result->fetch_array(); // there should be only one row
 
 	$id = $row[0];
 
@@ -122,57 +128,74 @@
 function withdraw_cash($id, $password, $amount) {
 
 	global $dbhost, $dbuser, $dbpass, $dbname;
-	
-	$amount = floor($amount);
 
-        $mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
-   
-	$query = "SELECT bal FROM accounts WHERE password = '$password' AND id = $id";
-	debug($query);
-	$result = $mysqli->query($query) or die($mysqli->error());
-        $row = $result->fetch_array(); // there should be only one row
+	if (!is_numeric($amount) or floor($amount) <= 0) {
+		action_error("Amount must be a positive number!", "'$amount'");
+	} else {
+		$amount = floor($amount);
 
-	$giver_has = $row[0];
+		$mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
 	
-	if ($amount > 0 && $giver_has >= $amount) {
-		$giver_has = $giver_has - $amount; // there's a problem here but it's not SQL Injection...
-		pretend("withdraw cash", $amount);
-		$query = "UPDATE accounts SET bal = $giver_has WHERE password = '$password' AND id = $id LIMIT 1";
-		$mysqli->query($query) or die($mysqli->error());
-		echo "<h2 align='center'>Cash withdrawal of $$amount complete.</h2>
-		      <h3 align='center'>Your cash should be ready in accounting within 45 minutes.</h3>\n";
-	} else {
-		action_error("Problem with cash withdrawal!",
-	                     "'$id', '$giver_has', '$amount'");
+		$query = $mysqli->prepare("SELECT bal FROM accounts WHERE password = ? AND id = ?");
+		$query->bind_param('si', $password, $id);
+		debug($query);
+		$query->execute();
+		$result = $query->get_result() or die($mysqli->error());
+		$row = $result->fetch_array(); // there should be only one row
+
+		$giver_has = $row[0];
+
+		if ($amount > 0 && $giver_has >= $amount) {
+			$giver_has = $giver_has - $amount; // there's a problem here but it's not SQL Injection...
+			pretend("withdraw cash", $amount);
+			$query = $mysqli->prepare("UPDATE accounts SET bal = ? WHERE password = ? AND id = ? LIMIT 1");
+			$query->bind_param('isi', $giver_has, $password, $id);
+			$query->execute() or die($mysqli->error());
+			echo "<h2 align='center'>Cash withdrawal of $$amount complete.</h2>
+				<h3 align='center'>Your cash should be ready in accounting within 45 minutes.</h3>\n";
+		} else {
+			action_error("Problem with cash withdrawal!",
+							"'$id', '$giver_has', '$amount'");
+		}
 	}
+
 }
 
 
 function wire_funds($id, $password,  $bank, $account, $amount) {
 
 	global $dbhost, $dbuser, $dbpass, $dbname;
-	
-	$amount = floor($amount);
 
-        $mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
-   
-	$query = "SELECT bal FROM accounts WHERE password = '$password' AND id = $id";
-	debug($query);
-	$result = $mysqli->query($query) or die($mysqli->error);
-        $row = $result->fetch_array(); // there should be only one row
-	$giver_has = $row[0];
-	
-	if ($amount > 0 && $giver_has >= $amount && $bank && $account) {
-		$giver_has = $giver_has - $amount; // there's a problem here but it's not SQL Injection...
-		pretend("wire money", $amount, $bank, $acct);
-		$query = "UPDATE accounts SET bal = $giver_has WHERE password = '$password' AND id = $id LIMIT 1";
-		debug($query);
-		$mysqli->query($query) or die($mysqli->error());
-		echo "<h2 align='center'>Wire of $$amount to bank ($bank) account ($account) complete.</h2>\n";
+	if (!is_numeric($bank) or !is_numeric($account) or !is_numeric($amount) or floor($amount) <= 0) {
+		action_error("Routing Number, Account Number, and Amount must be numeric. Amount must also be positive.", 
+			"'$bank', '$account', '$amount'");
 	} else {
-		action_error("Problem with wire fund transfer!", 
-		             "'$id', '$amount', '$giver_has', '$bank', '$account'");
+		$amount = floor($amount);
+
+		$mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
+	
+		$query = $mysqli->prepare("SELECT bal FROM accounts WHERE password = ? AND id = ?");
+		$query->bind_param('si', $password, $id);
+		debug($query);
+		$query->execute();
+		$result = $query->get_result() or die($mysqli->error);
+		$row = $result->fetch_array(); // there should be only one row
+		$giver_has = $row[0];
+
+		if ($amount > 0 && $giver_has >= $amount && $bank && $account) {
+			$giver_has = $giver_has - $amount; // there's a problem here but it's not SQL Injection...
+			pretend("wire money", $amount, $bank, $acct);
+			$query = $mysqli->prepare("UPDATE accounts SET bal = ? WHERE password = ? AND id = ? LIMIT 1");
+			$query->bind_param('isi', $giver_has, $password, $id);
+			debug($query);
+			$query->execute() or die($mysqli->error());
+			echo "<h2 align='center'>Wire of $$amount to bank ($bank) account ($account) complete.</h2>\n";
+		} else {
+			action_error("Problem with wire fund transfer!", 
+						"'$id', '$amount', '$giver_has', '$bank', '$account'");
+		}
 	}
+	
 }
 
 function pretend() {
@@ -183,36 +206,46 @@
 function transfer_funds($giver_id, $password, $recipient, $amount) {
 
 	global $dbhost, $dbuser, $dbpass, $dbname;
-	
-	$amount = floor($amount);
-	$recipient_id = name_to_id($recipient);
 
-	$mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
-   
-	$query = "SELECT bal FROM accounts WHERE id = $giver_id OR id = $recipient_id";
-	debug($query);
-	$result = $mysqli->query($query) or die($mysqli->error);
-	$row = $result->fetch_array(); // there should be only one row
-		      
-	$recipient_has = $row[0];
-	$row =  $result->fetch_array();
-	$giver_has = $row[0];
-	debug("$giver_has, $recipient_has");
-	
-	if ($amount > 0 && $giver_has >= $amount && $recipient_has) {
-		$giver_has = $giver_has - $amount; // there's a problem here but it's not SQL Injection...
-		$recipient_has = $recipient_has + $amount; // does anyone know what it is?
-		$query = "UPDATE accounts SET bal = $recipient_has WHERE id = $recipient_id LIMIT 1";
-		debug($query);
-		$mysqli->query($query) or die($mysqli->error());
-		$query = "UPDATE accounts SET bal = $giver_has WHERE password = '$password' AND id = $giver_id LIMIT 1";
-		debug($query);
-		$mysqli->query($query) or die($mysqli->error());
-		echo "<h2 align='center'>Transfer of $$amount to $recipient complete.</h2>\n";
+	if (!is_numeric($amount) or floor($amount) <= 0) {
+		action_error("Amount must be a positive number!", "'$amount'");
 	} else {
-		action_error("Problem with employee fund transfer!",
-	                     "'$giver_id', '$recipient', '$amount', '$giver_has'");
+		$amount = floor($amount);
+		$recipient_id = name_to_id($recipient);
+	
+		$mysqli = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
+	   
+		$query = $mysqli->prepare("SELECT bal FROM accounts WHERE id = ? OR id = ?");
+		$query->bind_param('ii', $giver_id, $recipient_id);
+		debug($query);
+		$query->execute();
+		$result = $query->get_result() or die($mysqli->error);
+		$row = $result->fetch_array(); // there should be only one row
+		  
+		$giver_has = $row[0];
+		$row = $result->fetch_array();
+		$recipient_has = $row[0];
+		debug("$giver_has, $recipient_has");
+		
+		if ($amount > 0 && $giver_has >= $amount && $recipient_has) {
+			$giver_has = $giver_has - $amount; // there's a problem here but it's not SQL Injection...
+			$recipient_has = $recipient_has + $amount; // does anyone know what it is?
+			$query = $mysqli->prepare("UPDATE accounts SET bal = ? WHERE id = ? LIMIT 1");
+			$query->bind_param('ii', $recipient_has, $recipient_id);
+			debug($query);
+			$query->execute() or die($mysqli->error());
+			$query = $mysqli->prepare("UPDATE accounts SET bal = ? WHERE password = ? AND id = ? LIMIT 1");
+			$query->bind_param('isi', $giver_has, $password, $giver_id);
+			debug($query);
+			$query->execute() or die($mysqli->error());
+			echo "<h2 align='center'>Transfer of $$amount to $recipient complete.</h2>\n";
+		} else {
+			action_error("Problem with employee fund transfer!",
+							 "'$giver_id', '$recipient', '$amount', '$giver_has'");
+		}
 	}
+	
+	
 }
 
 function account_info($row) {
